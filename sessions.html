<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Priority Sections</title>

<style>
*{box-sizing:border-box;margin:0}
body{
  font-family:Arial;
  padding:40px;
  background:#16202e url("./giphy.gif") center/cover no-repeat;
}
h1{text-align:center;color:green;margin-bottom:30px}
.container{display:flex;flex-wrap:wrap;justify-content:center;gap:20px;align-items:flex-start}
.section{
  width:260px;padding:15px;border-radius:12px;
  background:white;box-shadow:0 4px 12px rgba(0,0,0,.08);
  transition:.25s ease
}
.section.medium-active{transform:scale(1.07)}
.section.high-active{transform:scale(1.12)}
h2{text-align:center;margin-bottom:10px}
.textbox-wrapper{display:flex;gap:5px;margin-bottom:6px}
.textbox-wrapper input{flex:1;padding:6px;border-radius:6px;border:1px solid #ccc}
.add-btn,.delete-btn,.btn{
  border:none;border-radius:6px;cursor:pointer;font-weight:bold
}
.add-btn{width:100%;padding:6px;margin-bottom:8px;background:#22c55e;color:white}
.delete-btn{width:30px;height:25px;background:#ef4444;color:white}
.buttons{display:flex;gap:5px}
.btn{flex:1;padding:6px;font-size:12px}
.low{background:#d1d5db}
.medium{background:#60a5fa;color:white}
.high{background:#ef4444;color:white}
.selected{outline:3px solid black}
h2[contenteditable]{outline:none}
</style>
</head>

<body>

<h1>Priority Sections</h1>
<div class="container" id="container"></div>

<script>
const sessionName = localStorage.getItem("session_name");
if(!sessionName) window.location.href="index.html";

const container=document.getElementById("container");

/* ---------- Helpers ---------- */

function adjustSpacing(){
  const levels=[...document.querySelectorAll(".section")].map(s=>
    s.classList.contains("high-active")?3:
    s.classList.contains("medium-active")?2:
    s.classList.contains("low-active")?1:0
  );
  const highest=Math.max(0,...levels);
  container.style.gap=["20px","24px","30px","40px"][highest];
}

function createTextbox(section,value=""){
  const group=section.querySelector(".textbox-group");
  const wrap=document.createElement("div");
  wrap.className="textbox-wrapper";
  wrap.innerHTML=`
    <input type="text" value="${value}">
    <button class="delete-btn">âœ–</button>
  `;
  wrap.querySelector("button").onclick=()=>wrap.remove();
  group.appendChild(wrap);
}

/* ---------- Section Builder ---------- */

function createSection(data={}){
  const section=document.createElement("div");
  section.className="section";

  const title = document.createElement("h2");
title.textContent = data.name || `Section ${i+1}`;
title.contentEditable = "true"; // allow editing
  title.addEventListener("keydown",e=>{
    if(e.key==="Enter"){e.preventDefault();title.blur();}
  });

  const textboxGroup=document.createElement("div");
  textboxGroup.className="textbox-group";

  const addBtn=document.createElement("button");
  addBtn.className="add-btn";
  addBtn.textContent="+ Add";
  addBtn.onclick=()=>createTextbox(section);

  const buttonsDiv=document.createElement("div");
  buttonsDiv.className="buttons";

  ["low","medium","high"].forEach(level=>{
    const btn=document.createElement("button");
    btn.className="btn "+level;
    btn.textContent=level[0].toUpperCase()+level.slice(1);
    btn.dataset.priority=level;

    btn.onclick=()=>{
      buttonsDiv.querySelectorAll(".btn").forEach(b=>b.classList.remove("selected"));
      section.classList.remove("low-active","medium-active","high-active");

      btn.classList.add("selected");
      section.classList.add(level+"-active");
      section.style.background=getComputedStyle(btn).backgroundColor;

      adjustSpacing();
    };

    buttonsDiv.appendChild(btn);
  });

  section.append(title,textboxGroup,addBtn,buttonsDiv);
  container.appendChild(section);

  /* ---- Load Data If Exists ---- */
    let texts = [];

    // Ensure data.textboxes exists
    if (data && data.textboxes) {
    // If already an array, use it; if string (from DB), parse it
    if (Array.isArray(data.textboxes)) {
        texts = data.textboxes;
    } else if (typeof data.textboxes === "string") {
        try {
        texts = JSON.parse(data.textboxes);
        } catch (e) {
        console.warn("Failed to parse textboxes:", data.textboxes);
        texts = [];
        }
    }
    }

    // If empty, start with a single blank textbox
    if (!texts || texts.length === 0) texts = [""];

    // Populate textboxes
    texts.forEach(t => createTextbox(section, t));

    // Set priority if exists
    if (data && data.priority) {
    const btn = section.querySelector(`[data-priority="${data.priority}"]`);
    if (btn) btn.click(); // activates styles properly
    }
}

/* ---------- Save ---------- */

function gatherSectionData() {
  return [...document.querySelectorAll(".section")].map((sec, i) => ({
    id: i + 1,
    name: sec.querySelector("h2")?.textContent || `Section ${i + 1}`, // <-- save title
    textboxes: [...sec.querySelectorAll(".textbox-group input")].map(input => input.value),
    priority: sec.querySelector(".btn.selected")?.dataset.priority || null
  }));
}

async function saveSections() {
  try {
    const payload = {
      session_name: sessionName,
      sections: Array.isArray(gatherSectionData())
        ? gatherSectionData()
        : []
    };

    console.log("Sending:", payload);

    await fetch("https://remindersbackend.onrender.com/save-sections", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

  } catch (err) {
    console.error("Save failed", err);
  }
}

/* ---------- Load ---------- */

async function loadSections() {
  try {
    const res = await fetch(`https://remindersbackend.onrender.com/get-sections/${sessionName}`);
    const data = await res.json();

    container.innerHTML = ""; // clear existing sections

    if (data.success && Array.isArray(data.sections) && data.sections.length) {
      console.log("Loaded sections:", data.sections);

      data.sections.forEach(sec => {
        // Safely parse textboxes
        let textboxes = [];
        if (sec.textboxes) {
          try {
            textboxes = Array.isArray(sec.textboxes)
              ? sec.textboxes
              : JSON.parse(sec.textboxes);
          } catch (e) {
            console.warn("Failed to parse textboxes for section", sec, e);
            textboxes = [];
          }
        }

        if (textboxes.length === 0) textboxes = [""]; // at least one textbox

        createSection({
          name: sec.name || `Section ${sec.section_id || "?"}`,
          textboxes,
          priority: sec.priority
        });
      });
    } else {
      // If no data, create 6 default sections
      for (let i = 1; i <= 6; i++) createSection({ name: `Section ${i}` });
    }
  } catch (err) {
    console.error("Load failed", err);
  }
}

/* ---------- Events ---------- */

window.addEventListener("DOMContentLoaded",loadSections);
window.addEventListener("beforeunload",saveSections);
setInterval(saveSections,15000);
</script>

</body>
</html>